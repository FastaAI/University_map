<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>3D 대학 지도 (VWorld)</title>

  <!-- ✅ 브이월드 WebGL 3D API 3.0 init -->
  <script type="text/javascript"
    src="https://map.vworld.kr/js/webglMapInit.js.do?version=3.0&apiKey=0168D7D6-3EC6-3C64-A691-149E7E7DD176"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(17, 24, 39, .88);
      --panel2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent: #60a5fa;

      --r: 14px;
      --pad: 10px;

      /* 모바일 thumb dock 기본 높이(접힘/펼침은 JS에서 제어) */
      --dock-collapsed: 64px;
      --dock-expanded: 230px;
      --dock-h: var(--dock-collapsed);

      --console-h: 110px;
      --console-font: 12px;
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, AppleSDGothicNeo, Pretendard, sans-serif; background:var(--bg); color:var(--text); overflow:hidden; }
    #vmap { position: absolute; inset: 0; }

    /* ===== PC 기본 UI (기존 유지) ===== */
    #topbar {
      position: absolute; left: 12px; top: 12px; z-index: 9999;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px; border-radius:14px;
      background: var(--panel); border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    #topbar input {
      width: 260px; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.20); background: rgba(255,255,255,.08);
      color:var(--text); outline:none;
    }
    #topbar button {
      padding:10px 12px; border-radius:12px; border:0; cursor:pointer;
      background:#111827; color:var(--text); font-weight:900;
    }
    #topbar button:hover { opacity:.95; }
    #msg {
      max-width: 520px;
      font-size: 13px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }

    #orbitBtn {
      position:absolute; right:12px; top:12px; z-index:9999;
      padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background:#111827; color:var(--text); cursor:pointer; font-weight:900;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* ===== 모바일 한 손 조작 모드 도킹 패널 ===== */
    #dock {
      position: absolute;
      left: 0; right: 0;
      bottom: 0;
      z-index: 10000;
      height: var(--dock-h);
      padding: calc(var(--pad) + env(safe-area-inset-bottom)) var(--pad) var(--pad) var(--pad);
      background: rgba(17,24,39,.92);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transform: translateZ(0);
      display: none; /* 기본은 PC에서 숨김, 모바일에서 표시 */
      transition: height .18s ease;
    }

    #dockHandle {
      position: absolute;
      left: 50%;
      top: 8px;
      transform: translateX(-50%);
      width: 92px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: rgba(255,255,255,.75);
      font-weight: 800;
      user-select: none;
      cursor: pointer;
    }
    #dockHandle .bar{
      width: 32px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
    }
    #dockHandle .arrow{
      font-size: 14px;
      line-height: 1;
      opacity: .9;
    }

    #dockInner{
      margin-top: 34px;
      display: grid;
      gap: 10px;
    }

    #dockForm{
      display:flex;
      gap:8px;
      align-items:center;
      margin:0;
    }
    #dockForm input{
      flex: 1;
      min-width: 0;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    #dockForm button{
      padding: 12px 12px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      background: #111827;
      color: var(--text);
      font-weight: 900;
      white-space: nowrap;
    }
    #dockForm button.secondary{
      background: #334155;
    }

    #dockMsg{
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-height: 64px;
      overflow: auto;
    }

    /* 콘솔(로그) */
    #console {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      padding: 10px 10px;
      height: var(--console-h);
      overflow: hidden;
      display: grid;
      gap: 8px;
    }
    #consoleHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      color: rgba(255,255,255,.75);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
    }
    #consoleHeader .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.70);
    }
    #logBox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: var(--console-font);
      line-height: 1.25;
      color: rgba(210,255,232,.92);
      white-space: pre;
      overflow: hidden;
      flex: 1;
    }

    /* ===== 모바일에서만 적용 ===== */
    @media (max-width: 820px) and (orientation: portrait) {
      :root{
        --console-h: 96px;
        --console-font: 11px;
      }

      /* PC용 topbar는 모바일에선 숨기고 dock로 대체 */
      #topbar { display:none; }
      #dock { display:block; }

      /* orbit 버튼은 “엄지에 닿게” 아래로 내리고 살짝 작게 */
      #orbitBtn{
        top: auto;
        right: 12px;
        bottom: calc(var(--dock-h) + 12px);
        padding: 10px 12px;
        border-radius: 12px;
      }
    }

    /* 아주 작은 폰 */
    @media (max-width: 420px) and (orientation: portrait) {
      #dockForm button{
        padding: 12px 10px;
      }
    }
  </style>
</head>

<body>
  <div id="vmap"></div>

  <!-- PC UI 유지 -->
  <div id="topbar">
    <form method="get" action="/3d" style="display:flex; gap:8px; align-items:center; margin:0;">
      <input name="name" value="{{ search or '' }}" placeholder="학교명 입력 (예: 서울대 / 연대)" />
      <button type="submit">Search</button>
      <button type="button" onclick="location.href='/'" style="background:#334155;">2D로</button>
    </form>
    <div id="msg">{{ message }}</div>
  </div>

  <!-- 모바일 thumb dock -->
  <div id="dock" aria-label="Mobile Controls">
    <div id="dockHandle" role="button" aria-label="Open controls">
      <span class="bar"></span>
      <span class="arrow" id="dockArrow">⬆️</span>
      <span class="bar"></span>
    </div>

    <div id="dockInner">
      <form id="dockForm" method="get" action="/3d" autocomplete="off">
        <input name="name" value="{{ search or '' }}" placeholder="학교명 입력 (예: 서울대 / 연대)" />
        <button type="submit">Search</button>
        <button class="secondary" type="button" onclick="location.href='/'">2D로</button>
      </form>

      <div id="dockMsg">{{ message }}</div>

      <div id="console" aria-label="Console">
        <div id="consoleHeader">
          <div>RADAR CONSOLE</div>
          <div class="pill" id="consoleStatus">IDLE</div>
        </div>
        <div id="logBox"></div>
      </div>
    </div>
  </div>

  <button id="orbitBtn" type="button">⟳ 360° Rotate</button>

  <script>
    // =========================
    // 0) 서버에서 온 값
    // =========================
    const INIT_LON = Number("{{ init_lon }}");
    const INIT_LAT = Number("{{ init_lat }}");
    const INIT_ALT = Number("{{ init_alt }}");
    const KML_URL = "{{ kml_url or '' }}";

    // =========================
    // 1) VWorld 3D 지도 생성
    // =========================
    const options = {
      mapId: "vmap",
      initPosition: new vw.CameraPosition(
        new vw.CoordZ(INIT_LON, INIT_LAT, INIT_ALT),
        new vw.Direction(0, -35, 0)
      ),
      logo: true,
      navigation: true
    };

    const map = new vw.Map();
    map.setOption(options);
    map.start();

    // =========================
    // 2) Cesium viewer 얻기
    // =========================
    function getCesiumViewer() {
      return (
        (map && map.getCesiumViewer && map.getCesiumViewer()) ||
        (map && map.getViewer && map.getViewer()) ||
        (map && map.viewer) ||
        (window.ws3d && window.ws3d.viewer) ||
        (window.viewer) ||
        null
      );
    }

    function waitViewer(maxTry=30) {
      return new Promise((resolve) => {
        let t = 0;
        const timer = setInterval(() => {
          const v = getCesiumViewer();
          t++;
          if (v || t >= maxTry) {
            clearInterval(timer);
            resolve(v);
          }
        }, 100);
      });
    }

    // =========================
    // 3) KML + 클릭 확대 + 360 회전
    // =========================
    let kmlDataSource = null;
    let orbitOn = false;
    let orbitTick = null;
    let orbitTarget = null; // Cartesian3

    function getScreenCenterTargetCartesian(viewer){
      const canvas = viewer.scene.canvas;
      const center = new Cesium.Cartesian2(canvas.clientWidth/2, canvas.clientHeight/2);
      const ray = viewer.camera.getPickRay(center);
      const cart = viewer.scene.globe.pick(ray, viewer.scene);
      return cart || null;
    }

    function setOrbitTargetFromEntity(viewer, entity){
      try {
        const t = viewer.clock.currentTime;
        const pos = entity && entity.position && entity.position.getValue(t);
        if (pos) orbitTarget = pos;
      } catch (e) {}
    }

    function flyToEntity(viewer, entity){
      if (!viewer || !entity) return;
      try {
        viewer.flyTo(entity, {
          duration: 1.15,
          offset: new Cesium.HeadingPitchRange(
            viewer.camera.heading,
            Cesium.Math.toRadians(-35),
            1100
          )
        });
        setOrbitTargetFromEntity(viewer, entity);
        return;
      } catch (e) {}

      const t = viewer.clock.currentTime;
      const pos = entity.position && entity.position.getValue(t);
      if (!pos) return;
      viewer.camera.flyTo({ destination: pos, duration: 1.15 });
      orbitTarget = pos;
    }

    function installClickZoom(viewer){
      const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

      handler.setInputAction(function(click){
        const picked = viewer.scene.pick(click.position);

        if (Cesium.defined(picked) && picked.id) {
          flyToEntity(viewer, picked.id);
          return;
        }

        if (kmlDataSource && kmlDataSource.entities) {
          const t = viewer.clock.currentTime;
          const ray = viewer.camera.getPickRay(click.position);
          const cart = viewer.scene.globe.pick(ray, viewer.scene);
          if (!cart) return;

          const carto = Cesium.Cartographic.fromCartesian(cart);
          const clickLat = Cesium.Math.toDegrees(carto.latitude);
          const clickLon = Cesium.Math.toDegrees(carto.longitude);

          let best = null;
          let bestDist = Infinity;

          kmlDataSource.entities.values.forEach(ent => {
            const p = ent.position && ent.position.getValue(t);
            if (!p) return;
            const c = Cesium.Cartographic.fromCartesian(p);
            const lat = Cesium.Math.toDegrees(c.latitude);
            const lon = Cesium.Math.toDegrees(c.longitude);
            const d = Math.hypot(lat - clickLat, lon - clickLon);
            if (d < bestDist) { bestDist = d; best = ent; }
          });

          if (best && bestDist < 0.01) {
            flyToEntity(viewer, best);
          }
        }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    }

    function startOrbit(viewer){
      if(!viewer) return;

      if(!orbitTarget){
        orbitTarget = getScreenCenterTargetCartesian(viewer);
      }
      if(!orbitTarget) return;

      const range = Cesium.Cartesian3.distance(viewer.camera.position, orbitTarget);
      const pitch = Cesium.Math.toRadians(-35);

      viewer.camera.lookAt(
        orbitTarget,
        new Cesium.HeadingPitchRange(viewer.camera.heading, pitch, range)
      );

      const ORBIT_SPEED = Cesium.Math.toRadians(0.35);
      orbitTick = function(){
        viewer.camera.rotateRight(ORBIT_SPEED);
      };

      viewer.clock.onTick.addEventListener(orbitTick);
      orbitOn = true;
    }

    function stopOrbit(viewer){
      if(!viewer) return;
      if(orbitTick){
        viewer.clock.onTick.removeEventListener(orbitTick);
        orbitTick = null;
      }
      viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
      orbitOn = false;
    }

    // =========================
    // 4) 모바일 도킹 패널 + 지도 리사이즈 트리거
    // =========================
    const dock = document.getElementById("dock");
    const dockArrow = document.getElementById("dockArrow");
    const handle = document.getElementById("dockHandle");

    let dockOpen = false;

    function isMobilePortrait(){
      return window.matchMedia("(max-width: 820px) and (orientation: portrait)").matches;
    }

    function setDock(open){
      dockOpen = !!open;
      const root = document.documentElement;

      if(!isMobilePortrait()) return;

      const h = dockOpen ? getExpandedDockHeight() : getCollapsedDockHeight();
      root.style.setProperty("--dock-h", h + "px");
      dockArrow.textContent = dockOpen ? "⬇️" : "⬆️";

      // 지도 빈공간 없애기: Cesium resize + 렌더 트리거
      const viewer = getCesiumViewer();
      if(viewer){
        try { viewer.resize(); } catch(e) {}
        try { viewer.scene.requestRender && viewer.scene.requestRender(); } catch(e) {}
      }
    }

    function getCollapsedDockHeight(){
      return 64 + (safeBottom());
    }

    function getExpandedDockHeight(){
      // 화면 높이에 따라 자동 조절(너무 커져서 지도 못쓰는거 방지)
      const vh = window.innerHeight || 700;
      const base = Math.min(260, Math.max(210, Math.round(vh * 0.34)));
      return base + safeBottom();
    }

    function safeBottom(){
      // env(safe-area-inset-bottom) 값을 JS로 못 읽으니 대충 보정값
      return 14;
    }

    handle.addEventListener("click", ()=> setDock(!dockOpen));

    // 화면 회전/리사이즈 시 재계산
    window.addEventListener("resize", ()=>{
      if(isMobilePortrait()){
        setDock(dockOpen);
      } else {
        // PC로 돌아가면 CSS 변수 초기화
        document.documentElement.style.setProperty("--dock-h", getCollapsedDockHeight() + "px");
      }
    }, { passive:true });

    // =========================
    // 5) 콘솔 로그 연출 (폭주 -> 클리어 -> 텀 -> 재시작)
    // =========================
    const logBox = document.getElementById("logBox");
    const consoleStatus = document.getElementById("consoleStatus");

    function nowTime(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function pushLog(line){
      if(!logBox) return;
      const lines = (logBox.textContent || "").split("\n").filter(Boolean);
      lines.push(line);
      // 너무 길면 자르기
      while(lines.length > 24) lines.shift();
      logBox.textContent = lines.join("\n");
    }

    function clearLogs(){
      if(!logBox) return;
      logBox.textContent = "";
    }

    function vibrate(ms){
      try {
        if (navigator.vibrate) navigator.vibrate(ms);
      } catch(e) {}
    }

    const LOG_POOL = [
      "Ping: vw.Map init handshake OK",
      "Cesium: scene ready",
      "Radar sweep: bearing sync",
      "Tiles: stream buffer warm",
      "Nav: gesture map bound",
      "KML: entity index build",
      "Trace: packet checksum OK",
      "Focus: target lock probe",
      "Render: requestRender()",
      "I/O: low-latency channel"
    ];

    let logTimer = null;

    function startLogShow(){
      if(!logBox || !consoleStatus) return;
      if(logTimer) return;

      consoleStatus.textContent = "RUN";
      logTimer = setInterval(()=>{
        const msg = LOG_POOL[Math.floor(Math.random()*LOG_POOL.length)];
        pushLog(`[${nowTime()}] ${msg}`);
      }, 420);
    }

    function stopLogShow(){
      if(logTimer){
        clearInterval(logTimer);
        logTimer = null;
      }
    }

    async function burstCycle(){
      if(!logBox || !consoleStatus) return;

      // 평상시 로그
      startLogShow();

      // 3~6초 뒤 폭주
      const baseDelay = 3000 + Math.random()*3000;
      setTimeout(async ()=>{
        consoleStatus.textContent = "BURST";
        vibrate(45);

        // 폭주: 짧은 간격으로 여러 줄
        stopLogShow();
        const burstCount = 30 + Math.floor(Math.random()*20);
        for(let i=0;i<burstCount;i++){
          const msg = LOG_POOL[Math.floor(Math.random()*LOG_POOL.length)];
          pushLog(`[${nowTime()}] >>> ${msg} #${String(i+1).padStart(2,"0")}`);
          // 폭주 속도
          await new Promise(r=>setTimeout(r, 35 + Math.random()*25));
        }

        // 클리어 연출
        consoleStatus.textContent = "CLEAR";
        vibrate(25);
        await new Promise(r=>setTimeout(r, 220));
        clearLogs();

        // 3~5초 텀
        consoleStatus.textContent = "WAIT";
        await new Promise(r=>setTimeout(r, 3000 + Math.random()*2000));

        // 다시 시작
        consoleStatus.textContent = "RUN";
        startLogShow();

        // 다음 사이클 재귀
        burstCycle();
      }, baseDelay);
    }

    // 모바일일 때만 콘솔 돌리기 (PC는 조용히)
    function bootConsoleIfMobile(){
      if(isMobilePortrait()){
        burstCycle();
      } else {
        stopLogShow();
      }
    }

    // =========================
    // 6) 부트
    // =========================
    async function boot(){
      const viewer = await waitViewer(50);
      if(!viewer){
        const el = document.getElementById("msg");
        const el2 = document.getElementById("dockMsg");
        if(el) el.textContent = "Cesium viewer 접근 실패(브이월드 초기화 확인 필요)";
        if(el2) el2.textContent = "Cesium viewer 접근 실패(브이월드 초기화 확인 필요)";
        return;
      }

      // 초기 모바일 dock 높이 세팅
      if(isMobilePortrait()){
        document.documentElement.style.setProperty("--dock-h", getCollapsedDockHeight() + "px");
        setDock(false);
      }

      // KML 로드
      if (KML_URL) {
        try {
          const ds = await Cesium.KmlDataSource.load(KML_URL, {
            camera: viewer.scene.camera,
            canvas: viewer.scene.canvas
          });
          kmlDataSource = ds;
          viewer.dataSources.add(ds);
          try { await viewer.zoomTo(ds); } catch(e) {}
        } catch (e) {
          const m = "KML 로드 실패: " + String(e);
          const el = document.getElementById("msg");
          const el2 = document.getElementById("dockMsg");
          if(el) el.textContent = m;
          if(el2) el2.textContent = m;
        }
      }

      installClickZoom(viewer);

      // 360° 회전 토글
      const orbitBtn = document.getElementById("orbitBtn");
      orbitBtn.addEventListener("click", ()=>{
        if(orbitOn){
          stopOrbit(viewer);
          orbitBtn.textContent = "⟳ 360° Rotate";
        } else {
          startOrbit(viewer);
          orbitBtn.textContent = "■ Stop";
        }
      });

      // 콘솔 시작
      bootConsoleIfMobile();
      window.addEventListener("resize", bootConsoleIfMobile, { passive:true });
    }

    boot();
  </script>
</body>
</html>
